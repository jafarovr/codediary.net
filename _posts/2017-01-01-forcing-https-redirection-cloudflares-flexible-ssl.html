---
layout: post
status: publish
published: true
title: Forcing HTTPS Redirection and Cloudflare's Flexible SSL
author:
  display_name: codediary.net
  login: codediary
  email: info@codediary.net
  url: ''
author_login: codediary
author_email: info@codediary.net
wordpress_id: 69
wordpress_url: https://codediary.net/?p=69
date: '2017-01-01 23:03:31 +0000'
date_gmt: '2017-01-01 19:03:31 +0000'
categories:
- Security
- Apache
- NGINX
tags: []
---
<p>CloudFlare launched <a href="https://blog.cloudflare.com/introducing-universal-ssl/">Universal SSL</a>, making SSL encryption available to everyone. 2 million sites have already signed up for the service.</p>
<p>It&rsquo;s very easy to setup a Flexible SSL. It only takes only 48hours to be active.<br />
<span id="more-415"></span></p>
<p>But if you force <strong>http</strong> to <strong>https</strong> redirection on your website with the following normal methods, a loop redirection occurs.</p>
<p><!--more--></p>
<p>To redirect a user from HTTP to HTTPS, you can use the following:</p>
<pre class="lang:default decode:true">RewriteCond %{HTTP:CF-Visitor} '"scheme":"http"' 
RewriteRule ^(.*)$ https://www.domain.com/$1 [L]</pre>
<p>Similarly, to require all traffic go over HTTPS on CloudFlare, you can use the following:</p>
<pre class="lang:default decode:true">RewriteCond %{HTTP:CF-Visitor} !'"scheme":"http"' 
RewriteRule ^(.*)$ https://www.domain.com/$1 [L]</pre>
<h6>FLEXIBLE SSL HTTPS REDIRECTION FOR NGINX</h6>
<pre class="lang:default decode:true">location / { 
  if ($http_x_forwarded_proto != "https") { 
    rewrite ^(.*)$ https://$server_name$1 permanent; 
  }</pre>
<h6>FLEXIBLE SSL HTTPS REDIRECTION VIA PHP</h6>
<pre class="lang:default decode:true">if ( isset( $_SERVER['HTTP_CF_VISITOR'] ) &amp;&amp; strpos( $_SERVER['HTTP_CF_VISITOR'], 'https' ) !== false ) { 
  $_SERVER['HTTPS'] = 'on'; 
}</pre>
<p>OR</p>
<pre class="lang:default decode:true">if($_SERVER['HTTP_X_FORWARDED_PROTO'] != "https") { 
  header("Location: https://" . $_SERVER["HTTP_HOST"] . $_SERVER["REQUEST_URI"]); 
  exit(); 
}</pre>
<p>You can also use the <a title="Introducing Page Rules" href="https://blog.cloudflare.com/introducing-pagerules-fine-grained-feature-co/">Cloudflare Pagerules</a> to force the https protocol.</p>
<p>For WordPress, there is a working plugin available called <a title="Cloudflare Flexible SSL fix" href="https://wordpress.org/plugins/cloudflare-flexible-ssl/" target="_blank" rel="noopener noreferrer">&ldquo;Cloudflare Flexible SSL&rdquo;</a>, I also use <a href="https://wordpress.org/plugins/ssl-insecure-content-fixer/" target="_blank" rel="noopener noreferrer">&ldquo;SSL Insecure Content Fixer&rdquo;</a> to load &ldquo;unsafe scripts&rdquo; in the admin section.</p>
<h6></h6>
