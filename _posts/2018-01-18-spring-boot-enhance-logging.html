---
layout: post
status: publish
published: true
title: 'Spring Boot: Enhance your logging'
author:
  display_name: codediary.net
  login: codediary
  email: info@codediary.net
  url: ''
author_login: codediary
author_email: info@codediary.net
wordpress_id: 240
wordpress_url: https://codediary.net/?p=240
date: '2018-01-18 01:23:02 +0000'
date_gmt: '2018-01-17 21:23:02 +0000'
categories:
- Tutorial
- Java
- Spring
- Spring Boot
- Logging
- Log4j
tags:
- spring
- spring boot
- logging
- mdc
---
<p>In this post I show how you can tune your Spring Boot application&rsquo;s logging output &ndash; such that it has even&nbsp;more information when you need to troubleshoot. The method is actually so&nbsp;generic that you can apply it to other types of Java applications as well &ndash; for example Java EE applications.</p>
<p><!--more--></p>
<h3>What you have today</h3>
<p>Firstly: what is wrong with the default&nbsp;logging we get in Spring Boot? Nothing, actually&nbsp;&ndash; but it&nbsp;<em>can</em>&nbsp;be better. As an example,&nbsp;let us consider the log output from a RESTful resource invocation to&nbsp;<em>/greetings/duke</em>&nbsp;which returns a plain text greeting:</p>
<pre>2016-08-16 21:57:56.269 INFO 29817 --- [o-auto-1-exec-1] com.moelholm.GreetingController : Request received. PathVariable is: [duke]
2016-08-16 21:57:56.271 INFO 29817 --- [o-auto-1-exec-1] com.moelholm.GreetingRepository : Retrieving standard greeting from the "datastore"
2016-08-16 21:57:56.271 INFO 29817 --- [o-auto-1-exec-1] com.moelholm.GreetingService : Formatting greeting for [duke]</pre>
<p>There are 3 log lines:&nbsp;from&nbsp;<em>GreetingController</em>,&nbsp;<em>GreetingService and&nbsp;GreetingRepository</em>. Now imagine a system with 30 simultaneous&nbsp;active users that perform such invocations:</p>
<ul>
<li>The&nbsp;log lines would be mixed from the different concurrent threads &ndash; making it rather difficult to reason about the sequence of events. The thread names do help us &ndash; but even they get&nbsp;reused: the typical web container re-uses the same threads for serving different requests. Effectively meaning that if we filter the logs for, say&nbsp;<em>o-auto-1-exec-1</em>, we would get all log lines ever served by that thread.</li>
<li>It is not possible to relate the log lines&nbsp;to the actual&nbsp;users. We really don&rsquo;t know&nbsp;<em>which</em>&nbsp;user caused&nbsp;<em>what</em>&nbsp;log lines.</li>
</ul>
<h3>What you can get</h3>
<p>This is better:</p>
<pre>2016-08-16 22:17:34.408 [userId:tux | requestId:3e21b7f3-3ba9-49b9-8390-4ab8987f995f] INFO 30158 --- [o-auto-1-exec-1] com.moelholm.GreetingController : Request received. PathVariable is: [duke]
2016-08-16 22:17:34.409 [userId:tux | requestId:3e21b7f3-3ba9-49b9-8390-4ab8987f995f] INFO 30158 --- [o-auto-1-exec-1] com.moelholm.GreetingRepository : Retrieving standard greeting from the "datastore"
2016-08-16 22:17:34.409 [userId:tux | requestId:3e21b7f3-3ba9-49b9-8390-4ab8987f995f] INFO 30158 --- [o-auto-1-exec-1] com.moelholm.GreetingService : Formatting greeting for [duke]</pre>
<p>Here we have&nbsp;the same 3 log lines as before. But this time we can see that they belong to the same HTTP request: the&nbsp;request with id&nbsp;<em>3e21b7f3-xxxxx</em>. We can also see that it is the user&nbsp;<em>tux</em>&nbsp;that caused these log lines.</p>
<p>The naive solution would be for you to prepend the&nbsp;<em>userId</em>&nbsp;and&nbsp;<em>requestId</em>&nbsp;to all log lines. But that&rsquo;s never going to happen. You will forget it. If not you &ndash; then your colleague. And it can even be difficult to get such information from subcomponents &ndash; for example the&nbsp;<em>GreetingRepository</em>: how does it know about the&nbsp;<em>requestId</em>? Don&rsquo;t even consider using&nbsp;<em>ThreadLocal</em>&lsquo;s now :).</p>
<p>The solution to get such &ldquo;omni present&rdquo; logging data is:&nbsp;<em>Mapped Diagnostic Context (MDC).&nbsp;</em>MDC&nbsp;is a&nbsp;feature that is supported in the most&nbsp;modern Java logging frameworks, for example:&nbsp;<em>Log4j</em>,&nbsp;<em>Log4j2</em>,&nbsp;<em>Logback</em>&nbsp;and more.</p>
<p>If you want to dig further into&nbsp;MDC, then take a look at&nbsp;<em>Logbacks</em>&nbsp;online documentation [1].</p>
<h3>How you get that in Spring Boot</h3>
<p>It&rsquo;s easy. First you tell Spring Boot&nbsp;<em>what</em>&nbsp;MDC data to render:</p>
<pre>logging.pattern.level=%X{mdcData}%5p</pre>
<p>Put this in&nbsp;<em>src/main/resources/application.properties.&nbsp;</em>Or supply it in any other way supported by the flexible configuration mechanism in Spring Boot. This property tells Spring Boot to render the MDC data variable&nbsp;<em>mdcData</em>&nbsp;just before the priority field in the log output. The priority field is the logging level (DEBUG, INFO, &hellip;) that you are used to see.</p>
<p>Then you maintain the MDC data variable&nbsp;<em>mdcData</em>&nbsp;using your logging API &ndash; here&nbsp;using SLF4J (over the default Logback provider in Spring Boot):</p>
<pre>@Component
public class RequestFilter&nbsp;implements Filter {
&nbsp;&nbsp;&nbsp;&nbsp;@Override
&nbsp;&nbsp;&nbsp;&nbsp;public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)&nbsp;throws IOException, ServletException {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Setup MDC data:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String mdcData = String.format("[userId:%s | requestId:%s] ", user(), requestId());
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MDC.put("mdcData", mdcData);&nbsp;//Variable 'mdcData' is referenced in Spring Boot's logging.pattern.level property
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chain.doFilter(request, response);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;finally {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Tear down MDC data:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// ( Important! Cleans up the ThreadLocal data again )
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MDC.clear();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;}
}</pre>
<p>Here we maintain&nbsp;the MDC data in a Servlet&nbsp;<em>Filter</em>. That is an excellent place to maintain it &ndash; if we&nbsp;work with HTTP requests (REST, SOAP, JSP, Servlet, Thymeleaf,&hellip;).&nbsp;If you have JMS listeners in your application &ndash; then you&rsquo;ll need to maintain the MDC data there too. Same applies with Quartz Jobs. And so on.</p>
<blockquote><p>You decide what you want in the MDC data.</p>
<p>Anything goes: URL, session id, request id, user id, ip address, &hellip;</p></blockquote>
<p>I chose to exemplify the use of MDC data with a&nbsp;user id and an HTTP request id generated when receiving inbound HTTP requests. I like the idea of generating a unique request id (for HTTP, JMS, etc). Especially if you serve it back to the&nbsp;caller&rsquo;s when Exceptions occur. Given such an ID you can easily find all relevant log output related to that problem. I also like the user id:&nbsp;it&nbsp;easily gives you an overview of what a certain user has been doing in the application. But please&nbsp;decide what works for you &ndash; I am certain you can find additional useful data to put in the MDC.</p>
<p>I prepared a&nbsp;<a href="https://github.com/nickymoelholm/smallexamples/tree/master/enhanced-logging" target="_blank" rel="noopener noreferrer">GitHub example</a>&nbsp;for your convenience &ndash; take a look at that for&nbsp;a working example. Or if you just want&nbsp;to look at the above code examples in their&nbsp;full context.</p>
<h3>Not using Spring Boot?</h3>
<p>Not using Spring Boot? Then consult your logging frameworks documentation. The entire concept, MDC, is not at all&nbsp;tied to Spring Boot. In fact: MDC existed in Log4j long before Spring Boot was created.</p>
<p>Source:&nbsp;<a href="https://moelholm.com/2016/08/16/spring-boot-enhance-your-logging/" target="_blank" rel="noopener noreferrer">https://moelholm.com/2016/08/16/spring-boot-enhance-your-logging/</a></p>
